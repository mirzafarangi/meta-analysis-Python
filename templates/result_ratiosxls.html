{% extends "layout.html" %}
{% block app %}
<h4> <a href="/ratios">Back </a></h4>
<p></p>
<p></p>

<a href="/return-file-ratioxl/" target="blank">
  <h5 align="center">Please Click to Download the results as an Excel file</h5>
</a>
<p></p>
<h4>Table.1 summary of studies</h4>
<div style="overflow-x:auto;">
      {{result_table}}
</div>


<p></p>
<h4>Table.2 Summary of results - fixed and random effect models</h4>
<h5>Results based on Risk Ratio</h5>
<div id="table" align="left">
  <table style="width:100%">
    <thead>
      <tr>
        <td>
          <center> <b> <font color="black">  </font> </b> </center>
        </td>

        <td>
          <center>
            <font color="#2E9AFE"> Ln(Risk Ratio average) </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> Risk Ratio average </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> SE </center>
          </font>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> 95%CI </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> z score </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> p value </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> Heterogeneity </font>
          </center>
        </td>

      </tr>
    </thead>
    <tbody>
      <tr>
        <td> <center> <font color="#FF9900"> Fixed Effect Model </font> </center> </td>
        <td> <center>{{LnRR_total_fixed}}</center> </td>
        <td> <center>{{RRave_fixed}}</center> </td>
        <td> <center>{{se_total_fixed}} </center></td>
        <td> <center>[{{lower_RRave_fixed}},{{upper_RRave_fixed}}] </center></td>
        <td> <center>{{z_score_fixed}} </center></td>
        <td> <center>{{p_value_fixed}} </center></td>
        <td> <center> I<sup>2</sup>={{Het_fixed}}% , Chi<sup>2</sup>={{qq}}, df={{degf}} </center></td>
      </tr>
      <tr>
        <td> <center> <font color="#FF9900"> Random Effect Model </font> </center> </td>
        <td> <center>{{LnRR_total_random}}</center> </td>
        <td> <center>{{RRave_random}}</center> </td>
        <td> <center>{{se_total_random}} </center></td>
        <td> <center>[{{lower_RRave_random}},{{upper_RRave_random}}] </center></td>
        <td> <center>{{z_score_random}} </center></td>
        <td> <center>{{p_value_random}} </center></td>
        <td> <center>I<sup>2</sup>={{Het_random}}%, Tau<sup>2</sup>={{t2}} </center></td>
      </tr>
    </tbody>
  </table>
</div>
<h5>Results based on Odds Ratio</h5>
<div id="table" align="left">
  <table style="width:100%">
    <thead>
      <tr>
        <td>
          <center> <b> <font color="black">  </font> </b> </center>
        </td>

        <td>
          <center>
            <font color="#2E9AFE"> Ln(Odds Ratio average) </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> Odds Ratio average </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> SE </center>
          </font>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> 95%CI  </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> z score </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> p value </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> Heterogeneity </font>
          </center>
        </td>

      </tr>
    </thead>
    <tbody>
      <tr>
        <td> <center> <font color="#FF9900"> Fixed Effect Model </font> </center> </td>
        <td> <center>{{LnOR_total_fixed}}</center> </td>
        <td> <center>{{ORave_fixed}}</center> </td>
        <td> <center>{{se_total_fixed_OR}} </center></td>
        <td> <center>[{{lower_ORave_fixed}},{{upper_ORave_fixed}}] </center></td>
        <td> <center>{{z_score_fixed_OR}} </center></td>
        <td> <center>{{p_value_fixed_OR}} </center></td>
        <td> <center>I<sup>2</sup>={{Het_fixed_OR}}% , Chi<sup>2</sup>={{qq_OR}}, df={{degf_OR}} </center></td>
      </tr>
      <tr>
        <td> <center> <font color="#FF9900"> Random Effect Model </font> </center> </td>
        <td> <center>{{LnRR_total_random}}</center> </td>
        <td> <center>{{ORave_random}}</center> </td>
        <td> <center>{{se_total_random_OR}} </center></td>
        <td> <center>[{{lower_ORave_random}},{{upper_ORave_random}}] </center></td>
        <td> <center>{{z_score_random_OR}} </center></td>
        <td> <center>{{p_value_random_OR}} </center></td>
        <td> <center>I<sup>2</sup>={{Het_random_OR}}%, Tau<sup>2</sup>={{t2_OR}} </center></td>
      </tr>
    </tbody>
  </table>
</div>

<div class="forest">
      <h4> Figure.1 Forestplot - fixed and random effect models</h4>
      <h5>Y: Studies, X: Risk Ratio</h5>

      <div id="chartdiv"></div>
      <div id="chart2div"></div>
</div>

<h4>Figure.2 Funnel Plot - fixed and random effect models </h4>
	<div id='myDiv0'><!-- Plotly chart will be drawn inside this DIV --></div>
  <p></p>
<div id='myDiv1'><!-- Plotly chart will be drawn inside this DIV --></div>
<p></p>
<h4>Table.3 Fail-N Safe </h4>
<p></p>
<b>Bias of the analysis regarding the file-drawer problem:</b><p></p>
Fail-N Safe, the number of studies (or samples) with a null effect (RR = 0) <br> needed to bring the calculated significance level of the pooled effect (p value < {{p_val}}) near the critical significance level (p value = 0.05), <br> is calculated as follows:
<p></p>
References:<br>
* Rosenberg, M. S. (2005). The file‐drawer problem revisited: a general weighted method for calculating fail‐safe numbers in meta‐analysis. Evolution, 59(2), 464-468.
<br>
* Rosenthal, R. (1979). The file drawer problem and tolerance for null results. Psychological bulletin, 86(3), 638.
<div id="table" align="left">
  <table style="width:100%">

    <tbody>
      <tr>
        <td>
          <center>
              <font color="black"> <b></b> </font>
            </center>
        </td>

        <td>
          <center>
            <font color="#FF7F50"> Rosenthal (1979) </font> <br> t<sub>c</sub>(&alpha; = 0.05, df = {{n_study}}) = {{t_c}}
          </center>
        </td>
        <td>
          <center>
            <font color="#3CB371"> Rosenberg (2005) </font> <br> Z<sub>c</sub>(&alpha; = 0.05) = 1.645
          </center>

        </td>

      </tr>
      <tr>
        <td>
          <center>
              <font color="black"> <b>Fail-N Safe</b> </font>
            </center>
        </td>

        <td>
          <center>
            <font color="#2E9AFE"> {{fns_rosenthal}} </font>
          </center>
        </td>
        <td>
          <center>
            <font color="#2E9AFE"> {{fns_rosenberg}} </font>
          </center>

        </td>

      </tr>
    </tbody>
  </table>
</div>
<p></p>
<div class="regress" style="display:inline-block;">
  <p></p>
  <h4>Table.4 Results of Meta regression </h4>
  <p></p>
  <div style="overflow-x:auto;">
    {{moder | safe}}
  </div>
</div>
<p></p>
<p></p>

<hr>
<p></p>

      <h4>Dear Researcher,</h4><p></p>

      <b>Meta-Mar</b> wishes to thank you for giving us the opportunity to serve you. <br>

      Please help us serve you better by taking a couple of minutes to tell us about the service you have received so far. We value your research and want to make sure we meet your expectations. <p></p>

      Thank you for your time.
      <p></p>
    <h4> <a href="https://survey.sogosurvey.com/r/xEnmfo" target="_blank"> Take the survey! </a></h4>



{% endblock %}
{% block script %}
<script>
        const study = {{study_list | safe}}
        const rr = {{RR_list}}
        const rr_lower = {{lower_RR_list}}
        const rr_upper = {{upper_RR_list}}
        const rrf_w = {{weight_fixed_list}}
        const rr_w = {{weight_random_list}}
        const list = []
        var s=[]
        s.push({
        "category": "",
        "measure": 0,
        "bullet": "",
        "bulletSize": 0,
        "high": 0,
        "low": 0
        })
        for (var i=0; i<rr.length; i++) {
         s.push({
            "category": study[i],
            "measure": rr[i].toFixed(3),
            "bullet": "square",
            "bulletSize": rrf_w[i].toFixed(0),
            "high": rr_upper[i].toFixed(3),
            "low": rr_lower[i].toFixed(3)
            })}
            s.push({
               "category": "fixed model",
               "measure": {{RRave_fixed}},
               "bullet": "diamond",
               "bulletSize": 25,
               "high": {{upper_RRave_fixed}},
               "low": {{lower_RRave_fixed}}
               })
        var chart = AmCharts.makeChart("chartdiv", {
        "type": "serial",
        "theme": "light",
        "rotate": true,
        "fontSize": 18,
        "categoryAxis": {
        "gridAlpha": 0,
        },
        "valueAxes": [{
        "guides": [{
        "value": 2.2,
        "dashLength": 3,
        "lineThickness": 2
        }]
        }],
        "chartCursor": {
        "fullWidth": true,
        "graphBulletSize": 1,
        "categoryBalloonEnabled": false,
        "cursorAlpha": 0.1
        },
        "dataProvider": s,
        "graphs": [{
        "lineAlpha": 0,
        "bulletField": "bullet",
        "bulletSizeField": "bulletSize",
        "valueField": "measure",
        "lineColor": "#00c20d",
        "balloonText": "<strong>[[value]]</strong> 95%CI RR([[low]],[[high]])"
        }, {
        "type": "ohlc",
        "highField": "high",
        "lowField": "low",
        "openField": "measure",
        "closeField": "measure",
        "fixedColumnWidth": 1,
        "lineColor": "#00c20d",
        "showBalloon": false
        }],
        "categoryField": "category"
        });
        var t=[]
        t.push({
        "category": "",
        "measure": 0,
        "bullet": "",
        "bulletSize": 0,
        "high": 0,
        "low": 0
        })
        for (var i=0; i<rr.length; i++) {
         t.push({
            "category": study[i],
            "measure": rr[i].toFixed(3),
            "bullet": "square",
            "bulletSize": rr_w[i].toFixed(0),
            "high": rr_upper[i].toFixed(3),
            "low": rr_lower[i].toFixed(3)
            })}
            t.push({
               "category": "random model",
               "measure": {{RRave_random}},
               "bullet": "diamond",
               "bulletSize": 25,
               "high": {{upper_RRave_random}},
               "low": {{lower_RRave_random}}
               })
        var chart = AmCharts.makeChart("chart2div", {
        "type": "serial",
        "theme": "light",
        "rotate": true,
        "fontSize": 18,
        "categoryAxis": {
        "gridAlpha": 0,
        },
        "valueAxes": [{
        "guides": [{
        "value": 2.2,
        "dashLength": 3,
        "lineThickness": 2
        }]
        }],
        "chartCursor": {
        "fullWidth": true,
        "graphBulletSize": 1,
        "categoryBalloonEnabled": false,
        "cursorAlpha": 0.1
        },
        "dataProvider": t,
        "graphs": [{
        "lineAlpha": 0,
        "bulletField": "bullet",
        "bulletSizeField": "bulletSize",
        "valueField": "measure",
        "lineColor": "#00c20d",
        "balloonText": "<strong>[[value]]</strong> 95%CI RR([[low]],[[high]])"
        }, {
        "type": "ohlc",
        "highField": "high",
        "lowField": "low",
        "openField": "measure",
        "closeField": "measure",
        "fixedColumnWidth": 1,
        "lineColor": "#00c20d",
        "showBalloon": false
        }],
        "categoryField": "category"
        });
</script>
<script type="text/javascript">
var RR = {{RR_list}};
var sRR = {{se_RR_list}};
var RR_ave = {{RRave_random}};

  var trace1 = {
    x: RR,
    y: sRR,
    mode: 'markers',
    type: 'scatter',
    marker: { size: 12 },
    name: "Risk Ratio"
  };
  var trace2 = {
    x: [RR_ave, RR_ave, RR_ave],
    y: [0, 0.5, 1],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };
  var trace3 = {
    x: [Math.min.apply(Math, RR)-0.2, RR_ave, 2*RR_ave - Math.min.apply(Math, RR)+0.2],
    y: [0, 1, 0],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };
  var trace4 = {
    x: [RR_ave, RR_ave, RR_ave],
    y: [0, 1, 2],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };

  var data = [ trace1, trace2, trace3, trace4 ];

  var layout = {
    xaxis: {
      range: [ 0, 2 ]
    },
    yaxis: {
      range: [0, 1]
    },
    title:'Funnel Plot random model (Y: Standard Error - X: Risk Ratio)'
  };

  Plotly.newPlot('myDiv0', data, layout);


</script>
<script type="text/javascript">
var RR = {{RR_list}};
var sRR = {{se_RR_list}};
var RR_ave_f = {{RRave_fixed}};

  var trace1 = {
    x: RR,
    y: sRR,
    mode: 'markers',
    type: 'scatter',
    marker: { size: 12 },
    name: "Risk Ratio"
  };
  var trace2 = {
    x: [RR_ave_f, RR_ave_f, RR_ave_f],
    y: [0, 0.5, 1],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };
  var trace3 = {
    x: [Math.min.apply(Math, RR)-0.2, RR_ave_f, 2*RR_ave_f - Math.min.apply(Math, RR)+0.2],
    y: [0, 1, 0],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };
  var trace4 = {
    x: [RR_ave_f, RR_ave_f, RR_ave_f],
    y: [0, 1, 2],
    mode: 'lines',
    type: 'scatter',
    name: ''
  };

  var data = [ trace1, trace2, trace3, trace4 ];

  var layout = {
    xaxis: {
      range: [ 0, 2 ]
    },
    yaxis: {
      range: [0, 1]
    },
    title:'Funnel Plot fixed model (Y: Standard Error - X: Risk Ratio)'
  };

  Plotly.newPlot('myDiv1', data, layout);


</script>
  <script>
    google.charts.load('current', {
    callback: function () {
      var data = new google.visualization.DataTable();

      data.addColumn('string', 'Element');
      data.addColumn('number', 'effect size');
      data.addColumn({type: 'string', role: 'annotation'});
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn('number', 'effect size');
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn({type: 'number', role: 'interval'});
  var list_gg_random = {{list_gg_random}};
  var ke_ke = {{ke_ke | safe}};
  var g_ave_r = {{ave_g_random}};
  var gg_low_random = {{gg_low_random}};
  var gg_upp_random = {{gg_upp_random}};
  arrSum = function(arr){
    return arr.reduce(function(a,b){
      return a + b
    }, 0);
    sum_gg_random = arrSum(list_gg_random)
  }
  for (var i=0; i<gg_low_random.length; i++) {
      data.addRows([
        [ke_ke[i], list_gg_random[i], '.', gg_low_random[i], gg_upp_random[i], list_gg_random[i], gg_low_random[i], gg_upp_random[i]]
      ])};

      var options = {
        annotations: {
          stem: {
            color: 'transparent',
            length: -6
          },
          textStyle: {
            auraColor: '#ffffff',
            color: '#000000'
          }
        },
        pointSize: 3,
        legend: 'none',
        orientation: 'horizontal',
        vAxis: {
          minValue: -1,
          ticks: [0, 1, 2, 3, parseInt(3+g_ave_r)],
          gridlines: {color: '#333', minSpacing: 1}
        },
      };

      var chart = new google.visualization.ScatterChart(document.getElementById('chart_div_random'));
      chart.draw(data, options);
    },
    packages: ['corechart']
  });
  </script>
  <script>
    google.charts.load('current', {
    callback: function () {
      var data = new google.visualization.DataTable();

      data.addColumn('string', 'Element');
      data.addColumn('number', 'effect size');
      data.addColumn({type: 'string', role: 'annotation'});
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn('number', 'effect size');
      data.addColumn({type: 'number', role: 'interval'});
      data.addColumn({type: 'number', role: 'interval'});
  var list_gg_fixed = {{list_gg_fixed}};
  var ke_ke = {{ke_ke | safe}};
  var g_ave_f = {{ave_g_fixed}};

  var gg_low_fixed = {{gg_low_fixed}};
  var gg_upp_fixed = {{gg_upp_fixed}};
  arrSum = function(arr){
    return arr.reduce(function(a,b){
      return a + b
    }, 0);
    sum_gg_fixed = arrSum(list_gg_fixed)
  }
  for (var i=0; i<gg_low_fixed.length; i++) {
      data.addRows([
        [ke_ke[i], list_gg_fixed[i], '.', gg_low_fixed[i], gg_upp_fixed[i], list_gg_fixed[i], gg_low_fixed[i], gg_upp_fixed[i]]
      ])};

      var options = {
        annotations: {
          stem: {
            color: 'transparent',
            length: -6
          },
          textStyle: {
            auraColor: '#ffffff',
            color: '#000000'
          }
        },
        pointSize: 3,
        legend: 'none',
        orientation: 'horizontal',
        vAxis: {
          minValue: -1,
          ticks: [0, 1, 2, 3, parseInt(1+g_ave_f)],
          gridlines: {color: '#333', minSpacing: 1}
        },

      };

      var chart = new google.visualization.ScatterChart(document.getElementById('chart_div_fixed'));
      chart.draw(data, options);
    },
    packages: ['corechart']
  });
  </script>
{% endblock %}
